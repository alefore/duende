Can you see if you can find duplicated logic that you could extract to a common function, to make things simpler?

If not, please just say so (don't hallucinate any code).
