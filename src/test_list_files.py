# DO NOT EDIT. This file is automatically generated by Duende.
import unittest
import asyncio
import os
import tempfile
import shutil
import aiofiles
import pathlib
import re

from file_access_policy import CurrentDirectoryFileAccessPolicy, RegexFileAccessPolicy
from agent_command import CommandOutput
from list_files import list_all_files


class ListAllFilesTest(unittest.IsolatedAsyncioTestCase):
  """Contains a good set of tests for `list_all_files`."""

  def setUp(self):
    self.original_cwd = os.getcwd()
    self.temp_dir = pathlib.Path(tempfile.mkdtemp())
    os.chdir(self.temp_dir)
    self._setUpInitialStructure()

  def _setUpInitialStructure(self):
    """Sets up the following structure (with empty files):

    animals/mammals: dog.txt, cat.txt, fox.txt
    animals/birds: tucan.jpg, condor.txt
    fruits: banana.md, orange.md
    """
    # ‚ú® create directory structure
    os.makedirs("animals/mammals")
    os.makedirs("animals/birds")
    os.makedirs("fruits")

    # Create files
    for f in ["animals/mammals/dog.txt", "animals/mammals/cat.txt", "animals/mammals/fox.txt",
              "animals/birds/tucan.jpg", "animals/birds/condor.txt",
              "fruits/banana.md", "fruits/orange.md"]:
      with open(f, "w") as fp:
        fp.write("")
    # ‚ú®

  def tearDown(self):
    os.chdir(self.original_cwd)
    shutil.rmtree(self.temp_dir)

  async def testRoot(self):
    """Root search (".") finds expected number of files."""
    # ‚ú® root
    output: CommandOutput = await list_all_files(".")
    self.assertEqual(len(output.file_paths), 7)
    # ‚ú®

  async def testRootFormat(self):
    """The output of root search (".") is as expected.

    Expected format: "fruits/banana.md"."""
    # ‚ú® expected output root
    output: CommandOutput = await list_all_files(".")
    file_paths = sorted(output.file_paths)  # Sort for consistent order

    self.assertIn("fruits/banana.md", file_paths)
    self.assertIn("animals/mammals/dog.txt", file_paths)
    self.assertIn("animals/birds/tucan.jpg", file_paths)

    # Validate format for a few entries
    for path in file_paths:
      self.assertTrue(re.match(r"^[a-zA-Z0-9_]+/.*\.[a-zA-Z0-9_]+$", path))
    # ‚ú®

  async def testEmpty(self):
    """No files are returned for a search in an empty directory."""
    # ‚ú® empty
    os.makedirs("empty_dir")
    output: CommandOutput = await list_all_files("empty_dir")
    self.assertEqual(len(output.file_paths), 0)
    # ‚ú®

  async def testFlat(self):
    """Search in a flat directory returns expected number of outputs."""
    # ‚ú® flat
    output: CommandOutput = await list_all_files("fruits")
    self.assertEqual(len(output.file_paths), 2)
    # ‚ú®

  async def testFlatFormat(self):
    """Search in flat directory returns entries with expected format.

    Expected format: "animals/birds/condor.txt"."""
    # ‚ú® flat format
    output: CommandOutput = await list_all_files("animals/birds")
    file_paths = sorted(output.file_paths)
    self.assertListEqual(file_paths, ["animals/birds/condor.txt", "animals/birds/tucan.jpg"])
    # ‚ú®

  def testNestedDirs(self):
    """Search in animals outputs five entries in the expected format."""
    # {{üçÑ nested dirs}}

  def testFileAccessPolicy(self):
    """Search in root directory only outputs entries allowed by access policy.

    Creates a regex file access policy matching two files and validates that
    the outputs are exactly as expected."""
    # {{üçÑ file access policy}}

  def testFileAccessPolicyNoMatch(self):
    """Runs successfully if file access policy doesn't match anything."""
    # {{üçÑ file access policy no match}}
